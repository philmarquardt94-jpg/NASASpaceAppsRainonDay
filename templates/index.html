<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trip Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2328;
      --muted:#6b7280;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#eef2ff;
      --line:#e5e7eb;
      --brand:#2563eb;
    }
    html, body { height:100%; margin:0; font-family:system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--ink); background:var(--bg); }
    #wrap { display:grid; grid-template-columns: 1fr 400px; height:100%; }
    #map { width:100%; height:100%; }
    aside { background:var(--card); border-left:1px solid var(--line); overflow:auto; padding:14px 14px 80px; }

    h1 { font-size:20px; margin:0 0 8px; }
    h2 { font-size:16px; margin:16px 0 8px; }
    .small { color:var(--muted); font-size:12px; }
    .row { margin-bottom:10px; }
    .input, select, button { font:inherit; }
    input[type="text"], input[type="number"], input[type="datetime-local"], select {
      width:100%; box-sizing:border-box; padding:8px; border:1px solid var(--line); border-radius:8px; background:#fff;
    }
    button { background:var(--brand); color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button.secondary { background:#eef2f7; color:#111; }
    button:disabled { opacity:.65; cursor:not-allowed; }

    /* panels */
    .panel { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    #errorPanel { display:none; border-color:var(--bad); background:#fff1f2; color:#991b1b; }

    /* condition rows */
    .cond-row, .trip { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 6px; border-bottom:1px dashed var(--line); }
    .cond-row:hover { background:#fafafa; cursor:pointer; }
    .cond-box, .prob-box {
      width:14px; height:14px; border-radius:3px; border:1px solid var(--line); margin-right:4px; flex:0 0 14px;
    }
    .good { color:var(--good) !important; }
    .warn { color:var(--warn) !important; }
    .bad  { color:var(--bad) !important; }
    .cond-box.good { background:#d1fae5; border-color:#10b981; }
    .cond-box.warn { background:#fef3c7; border-color:#f59e0b; }
    .cond-box.bad  { background:#fee2e2; border-color:#ef4444; }
    .prob-box.good { background:#d1fae5; border-color:#10b981; }
    .prob-box.warn { background:#fef3c7; border-color:#f59e0b; }
    .prob-box.bad  { background:#fee2e2; border-color:#ef4444; }

    .cond-name { flex:1 1 auto; }
    .cond-range { color:var(--muted); font-size:12px; margin-left:auto; }
    .metaChip {
      display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip);
      color:#334155; font-size:12px; margin-left:6px;
    }

    /* modal */
    #modalOverlay {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25);
      z-index: 9999;
    }
    #modal {
      width:min(1000px, 92vw); background:#fff; border-radius:14px; border:1px solid var(--line); box-shadow:0 10px 24px rgba(0,0,0,.2);
      max-height: 86vh; display:flex; flex-direction:column; overflow:hidden;
    }
    #modalHeader { padding:12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:8px; }
    #modalHeaderLeft { display:flex; flex-direction:column; gap:2px; }
    #modalHeaderRight { display:flex; align-items:center; gap:8px; }
    #modalBody { padding:12px; overflow:auto; }
    #timeline { height:220px; border:2px dashed var(--line); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--muted); margin-bottom:8px; }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-top:1px solid var(--line); text-align:left; font-size:14px; }
    thead th { background:#f8fafc; position:sticky; top:0; z-index:2; }

    /* top summary colors */
    .good b { color:var(--good); }
    .bad b  { color:var(--bad); }

    /* --- HIDE NASA Uncertainty panel & "Chance to Flip" column --- */
    #probPanel { display: none !important; }
    #modal thead th:nth-child(5),
    #modal tbody td:nth-child(5) { display: none; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="map"></div>

    <aside>
      <h1>Selected Place</h1>
      <div id="placeInfo" class="panel small">
        Click on the map to choose a location.
      </div>

      <div class="panel">
        <h2>Plan a Trip</h2>
        <div class="row">
          <label>Name:</label>
          <input id="tripName" type="text" value="Fishing" />
        </div>

        <div class="row small">
          Time Window &nbsp; <span class="small">(Timezone: <span id="tzText">UTC</span>)</span>
        </div>
        <div class="row">
          <label>Start</label>
          <input id="startLocal" type="datetime-local" />
        </div>
        <div class="row">
          <label>End</label>
          <input id="endLocal" type="datetime-local" />
        </div>

        <div class="row">
          <label>Data Source:</label>
          <select id="dataSource">
            <option value="open-meteo">Open-Meteo (default)</option>
            <option value="nasa-power">NASA POWER (experimental)</option>
            <option value="combined">Combined (OM values + POWER uncertainty)</option>
          </select>
          <div class="small">NASA POWER docs: <a href="https://power.larc.nasa.gov/docs/services/api/" target="_blank" rel="noopener">open in browser</a></div>
        </div>

        <h2>Conditions (toggle what to care about)</h2>
        <div class="row">
          <label><input id="chkPProb" type="checkbox" checked /> Precip. probability ≤</label>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <input id="pprobMax" type="number" step="1" value="40" style="max-width:90px;" />
            <span class="small" style="align-self:center;">%</span>
          </div>
        </div>

        <div class="row">
          <label><input id="chkPAmt" type="checkbox" /> Precip. amount ≤</label>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <input id="pamtMax" type="number" step="0.01" value="0.10" style="max-width:90px;" />
            <select id="pamtUnit" style="max-width:80px;">
              <option value="in">in</option>
              <option value="mm">mm</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label><input id="chkTemp" type="checkbox" checked /> Temperature between</label>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <input id="tMin" type="number" step="1" value="55" style="max-width:90px;" />
            <span style="align-self:center;">and</span>
            <input id="tMax" type="number" step="1" value="85" style="max-width:90px;" />
            <select id="tUnit" style="max-width:80px;">
              <option value="F">F</option>
              <option value="C">C</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label><input id="chkHum" type="checkbox" /> Humidity between</label>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <input id="hMin" type="number" step="1" placeholder="min" style="max-width:90px;" />
            <span style="align-self:center;">and</span>
            <input id="hMax" type="number" step="1" placeholder="max" style="max-width:90px;" />
            <span class="small" style="align-self:center;">%</span>
          </div>
        </div>

        <div class="row">
          <label><input id="chkWind" type="checkbox" checked /> Wind speed ≤ <span class="small">(or leave blank) ≥</span></label>
          <div style="display:flex; gap:8px; margin-top:6px; align-items:center;">
            <input id="wMax" type="number" step="1" value="20" style="max-width:90px;" />
            <span class="small">/</span>
            <input id="wMin" type="number" step="1" placeholder="min" style="max-width:90px;" />
            <select id="wUnit" style="max-width:80px;">
              <option value="mph">mph</option>
              <option value="m/s">m/s</option>
            </select>
          </div>
        </div>

        <div class="row" style="display:flex; justify-content:flex-start;">
          <button id="runBtn">Run Trip Check</button>
        </div>
      </div>

      <div id="errorPanel" class="panel"></div>

      <div id="planResult" class="panel"></div>

      <div id="condPanel" class="panel" style="display:none;">
        <h2>Condition Status</h2>
        <div id="condRows"></div>
        <div class="small" style="margin-top:8px;">Tip: Click a row to view the full timeline for that factor.</div>
      </div>

      <div id="suggestPanel" class="panel" style="display:none;">
        <h2>Timing Suggestions</h2>
        <div id="unidealSpans" class="small"></div>
        <div id="altWindows" class="small" style="margin-top:10px;"></div>
      </div>

      <!-- Hidden via CSS -->
      <div id="probPanel" class="panel" style="display:none;">
        <h2>Uncertainty (NASA)</h2>
        <div id="probRows"></div>
        <div class="small" style="margin-top:8px;">
          Note: Yellow = uncertain (≥30% chance to flip outcome), Green = likely OK, Red = likely No-Go.
        </div>
      </div>

      <div class="panel">
        <h2>My Trips</h2>
        <div id="tripsList" class="small">No trips yet.</div>
        <div style="margin-top:8px;">
          <button id="refreshTrips" class="secondary">Refresh</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Factor Modal -->
  <div id="modalOverlay">
    <div id="modal">
      <div id="modalHeader">
        <div id="modalHeaderLeft">
          <div style="font-weight:600;" id="factorTitle">Factor</div>
          <div class="small" id="factorSubtitle">Window</div>
          <div id="factorMeta" style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;"></div>
        </div>
        <div id="modalHeaderRight">
          <button id="downloadCSV" class="secondary">Download CSV</button>
          <button id="closeModal" class="secondary">Close</button>
        </div>
      </div>
      <div id="modalBody">
        <div id="timeline">Timeline chart placeholder</div>
        <table>
          <thead>
            <tr>
              <th style="width:120px;">Time</th>
              <th style="width:110px;">Value</th>
              <th style="width:70px;">Unit</th>
              <th style="width:90px;">Ideal</th>
              <!-- Hidden via CSS -->
              <th style="width:130px;">Chance to Flip</th>
              <th style="width:110px;">Overall OK</th>
              <th>Reasons</th>
            </tr>
          </thead>
          <tbody id="factorTBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- App JS -->
  <script src="/static/js/app.js"></script>
</body>
</html>
